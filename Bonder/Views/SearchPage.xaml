<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="Bonder.Views.SearchPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:Toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             Title="Search Books"
             BackgroundColor="{DynamicResource PrimaryBackground}">

    <Grid RowDefinitions="Auto,Auto,*"
          RowSpacing="0">

        <!-- Search Bar -->
        <Frame Grid.Row="0"
               Padding="16"
               Margin="16,16,16,0"
               BackgroundColor="{DynamicResource White}"
               CornerRadius="20"
               HasShadow="True">
            <Grid ColumnDefinitions="*,Auto,Auto"
                  ColumnSpacing="12">
                <Entry Grid.Column="0"
                       Placeholder="Search books, authors..."
                       Text="{Binding SearchQuery}"
                       FontSize="16"
                       BackgroundColor="Transparent"
                       VerticalOptions="Center">
                    <Entry.Behaviors>
                        <Toolkit:EventToCommandBehavior EventName="TextChanged"
                                                        Command="{Binding SearchCommand}" />
                    </Entry.Behaviors>
                </Entry>

                <Button Grid.Column="1"
                        Text="ðŸ”"
                        FontSize="20"
                        BackgroundColor="Transparent"
                        Command="{Binding SearchCommand}" />

                <Button Grid.Column="2"
                        Text="âš™ï¸"
                        FontSize="20"
                        BackgroundColor="Transparent"
                        Command="{Binding ShowFiltersCommand}" />
            </Grid>
        </Frame>

        <!-- Filter Summary -->
        <ScrollView Grid.Row="1"
                    Orientation="Horizontal"
                    Padding="16,12"
                    IsVisible="{Binding HasActiveFilters}">
            <HorizontalStackLayout Spacing="8"
                                   BindableLayout.ItemsSource="{Binding ActiveFilters}">
                <BindableLayout.ItemTemplate>
                    <DataTemplate>
                        <Frame Padding="12,6"
                               BackgroundColor="{DynamicResource PrimaryAccent}"
                               CornerRadius="16"
                               HasShadow="False">
                            <HorizontalStackLayout Spacing="8">
                                <Label Text="{Binding DisplayText}"
                                       FontSize="12"
                                       TextColor="{DynamicResource White}"
                                       VerticalOptions="Center" />
                                <Label Text="Ã—"
                                       FontSize="16"
                                       TextColor="{DynamicResource White}"
                                       VerticalOptions="Center">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RemoveFilterCommand}"
                                                              CommandParameter="{Binding .}" />
                                    </Label.GestureRecognizers>
                                </Label>
                            </HorizontalStackLayout>
                        </Frame>
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
            </HorizontalStackLayout>
        </ScrollView>

        <!-- Search Results -->
        <ScrollView Grid.Row="2">
            <VerticalStackLayout Spacing="0">

                <!-- Loading Indicator -->
                <ActivityIndicator IsRunning="{Binding IsSearching}"
                                   IsVisible="{Binding IsSearching}"
                                   Color="{DynamicResource PrimaryAccent}"
                                   HeightRequest="50"
                                   Margin="0,40,0,0" />

                <!-- Results -->
                <CollectionView ItemsSource="{Binding SearchResults}"
                                SelectionMode="None"
                                Margin="16"
                                IsVisible="{Binding IsSearching, Converter={StaticResource InverseBoolConverter}}">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Frame Padding="12"
                                   BackgroundColor="{DynamicResource White}"
                                   CornerRadius="16"
                                   Margin="0,0,0,12"
                                   HasShadow="True">
                                <Grid ColumnDefinitions="100,*"
                                      ColumnSpacing="16">
                                    <!-- Book Cover -->
                                    <Frame Grid.Column="0"
                                           Padding="0"
                                           CornerRadius="12"
                                           HeightRequest="140"
                                           WidthRequest="100">
                                        <Image Source="{Binding CoverUrl}"
                                               Aspect="AspectFill">
                                            <Image.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ViewBookCommand}"
                                                                      CommandParameter="{Binding .}" />
                                            </Image.GestureRecognizers>
                                        </Image>
                                    </Frame>

                                    <!-- Book Info -->
                                    <VerticalStackLayout Grid.Column="1"
                                                         Spacing="8"
                                                         VerticalOptions="Center">
                                        <Label Text="{Binding Title}"
                                               FontSize="16"
                                               FontFamily="OpenSansSemibold"
                                               TextColor="{DynamicResource TextPrimary}"
                                               LineBreakMode="TailTruncation"
                                               MaxLines="2" />

                                        <Label Text="{Binding AuthorsDisplay}"
                                               FontSize="14"
                                               TextColor="{DynamicResource TextSecondary}"
                                               LineBreakMode="TailTruncation" />

                                        <HorizontalStackLayout Spacing="8">
                                            <HorizontalStackLayout Spacing="4"
                                                                   IsVisible="{Binding Rating, Converter={StaticResource NotNullConverter}}">
                                                <Label Text="â­"
                                                       FontSize="14" />
                                                <Label Text="{Binding Rating, StringFormat='{0:F1}'}"
                                                       FontSize="13"
                                                       TextColor="{DynamicResource TextSecondary}"
                                                       VerticalOptions="Center" />
                                            </HorizontalStackLayout>

                                            <Label Text="â€¢"
                                                   FontSize="13"
                                                   TextColor="{DynamicResource TextLight}"
                                                   VerticalOptions="Center"
                                                   IsVisible="{Binding FirstPublishYear, Converter={StaticResource NotNullConverter}}" />

                                            <Label Text="{Binding FirstPublishYear}"
                                                   FontSize="13"
                                                   TextColor="{DynamicResource TextSecondary}"
                                                   VerticalOptions="Center"
                                                   IsVisible="{Binding FirstPublishYear, Converter={StaticResource NotNullConverter}}" />
                                        </HorizontalStackLayout>

                                        <FlexLayout Wrap="Wrap"
                                                    JustifyContent="Start"
                                                    BindableLayout.ItemsSource="{Binding Genres}">
                                            <BindableLayout.ItemTemplate>
                                                <DataTemplate>
                                                    <Frame BackgroundColor="{DynamicResource SecondaryBackground}"
                                                           CornerRadius="8"
                                                           Padding="8,4"
                                                           Margin="0,0,4,4"
                                                           HasShadow="False">
                                                        <Label Text="{Binding .}"
                                                               FontSize="11"
                                                               TextColor="{DynamicResource TextSecondary}" />
                                                    </Frame>
                                                </DataTemplate>
                                            </BindableLayout.ItemTemplate>
                                        </FlexLayout>

                                        <HorizontalStackLayout Spacing="8">
                                            <Button Text="â¤ï¸"
                                                    FontSize="16"
                                                    Padding="8"
                                                    CornerRadius="12"
                                                    BackgroundColor="{DynamicResource SecondaryBackground}"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.LikeBookCommand}"
                                                    CommandParameter="{Binding .}" />

                                            <Button Text="ðŸ’¾"
                                                    FontSize="16"
                                                    Padding="8"
                                                    CornerRadius="12"
                                                    BackgroundColor="{DynamicResource SecondaryBackground}"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SaveBookCommand}"
                                                    CommandParameter="{Binding .}" />
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>

                    <CollectionView.EmptyView>
                        <VerticalStackLayout Spacing="16"
                                             HorizontalOptions="Center"
                                             VerticalOptions="Center"
                                             Padding="40"
                                             Margin="0,60,0,0">
                            <Label Text="ðŸ”"
                                   FontSize="64"
                                   HorizontalOptions="Center" />
                            <Label Text="{Binding EmptyStateText}"
                                   FontSize="18"
                                   FontFamily="OpenSansSemibold"
                                   TextColor="{DynamicResource TextPrimary}"
                                   HorizontalOptions="Center" />
                            <Label Text="{Binding EmptyStateSubtext}"
                                   FontSize="14"
                                   TextColor="{DynamicResource TextSecondary}"
                                   HorizontalOptions="Center"
                                   HorizontalTextAlignment="Center" />
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>
                </CollectionView>

            </VerticalStackLayout>
        </ScrollView>

    </Grid>

</ContentPage>

<!-- Filter Bottom Sheet (as a separate popup) -->
<!-- This would typically be implemented as a custom control or popup -->